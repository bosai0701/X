<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>津波情報</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }

    /* 警報レベル別ヘッダー色 */
    .header-major {
      background: rgba(200,0,255);
      color: white;
    }
    .header-warning {
      background: rgba(255,40,0);
      color: white;
    }
    .header-advisory {
      background: rgba(250,245,0);
      color: black;
    }
    .header-forecast {
      background: #05BEFF;
      color: black;
    }
    .header-unknown {
      background: #78909c;
      color: white;
    }

    /* 凡例用スタイル */
    #legend {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    #legend span {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    /* メニューバースタイル */
    #menuBar {
      position: relative !important;
      top: 1.1%;
      left: 0px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 6px 12px;
      margin-left: 0px;
      margin-top: 0px;
      display: inline-block;
      font-size: 14px;
      user-select: none;
    }
    #menuBar select {
      font-size: 14px;
      border: none;
      background: transparent;
      outline: none;
      cursor: pointer;
    }

    /* ここから追加：最初は非表示に */
    h1, #tsunamiSections {
      display: none;
    }
  </style>
</head>
<body>

  <!-- メニューバー -->
  <div id="menuBar">
    <select id="infoSelector">
      <option value="quake">地震情報</option>
      <option value="tsunami" selected>津波情報</option>
    </select>
  </div>

  <h1>津波情報</h1>

  <div id="legend"></div>
  <div id="tsunamiSections"></div>

  <script>
    // 日時フォーマット関数
    function formatDateTime(dtStr) {
      if (!dtStr) return '---';
      const dt = new Date(dtStr);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth() + 1).padStart(2, '0');
      const dd = String(dt.getDate()).padStart(2, '0');
      const hh = String(dt.getHours()).padStart(2, '0');
      const mi = String(dt.getMinutes()).padStart(2, '0');
      return `${yyyy}年${mm}月${dd}日 ${hh}:${mi}`;
    }

    // 警報レベル別クラス取得
    function getHeaderClass(name) {
      if (name.includes("大津波")) return "header-major";
      if (name.includes("津波警報")) return "header-warning";
      if (name.includes("津波注意報")) return "header-advisory";
      if (name.includes("津波予報")) return "header-forecast";
      return "header-unknown";
    }

    // 凡例作成
    function createLegend(warningNamesSet) {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      warningNamesSet.forEach(name => {
        const span = document.createElement('span');
        span.className = getHeaderClass(name);
        span.textContent = name;
        legend.appendChild(span);
      });
    }

    // 津波情報取得＆表示
    async function loadTsunamiData() {
      const listUrl = "https://www.jma.go.jp/bosai/tsunami/data/list.json";
      try {
        const listRes = await fetch(listUrl);
        const listData = await listRes.json();
        if (!listData.length) throw new Error('津波データリストが空です');
        const latestFileName = listData[0].json;
        const latestUrl = `https://www.jma.go.jp/bosai/tsunami/data/${latestFileName}`;

        const res = await fetch(latestUrl);
        const data = await res.json();

        const sectionContainer = document.getElementById('tsunamiSections');
        sectionContainer.innerHTML = '';

        const items = data.Body.Tsunami?.Forecast?.Item || [];
        const announceTime = formatDateTime(data.Head?.TargetDateTime);

        const grouped = {};
        const warningNamesSet = new Set();

        items.forEach(item => {
          const warningName = item.Category?.Kind?.Name || '（区分不明）';
          warningNamesSet.add(warningName);
          if (!grouped[warningName]) grouped[warningName] = [];
          grouped[warningName].push(item);
        });

        // 発令されている警報4種のいずれかがあるか判定用セット
        const targetWarnings = new Set([
          "大津波警報",
          "津波警報",
          "津波注意報",
          "津波予報"
        ]);
        const hasWarnings = [...warningNamesSet].some(name => {
          return [...targetWarnings].some(warn => name.includes(warn));
        });

        if (!hasWarnings) {
          sectionContainer.innerHTML = '<p style="text-align:center; font-weight:bold; font-size:1.2em; margin-top: 20px;">大津波警報・津波警報・津波注意報・津波予報は発表されていません</p>';
          document.getElementById('legend').innerHTML = '';
          // 表示切り替え
          document.querySelector('h1').style.display = 'block';
          sectionContainer.style.display = 'block';
          return;
        }

        createLegend(warningNamesSet);

        Object.entries(grouped).forEach(([warningName, items]) => {
          const section = document.createElement('section');

          const heading = document.createElement('h2');
          heading.textContent = warningName;
          section.appendChild(heading);

          const headerClass = getHeaderClass(warningName);

          const table = document.createElement('table');
          table.innerHTML = `
            <thead>
              <tr class="${headerClass}">
                <th>地域</th>
                <th>観測点</th>
                <th>観測状況</th>
                <th>満潮時刻</th>
                <th>発表時刻</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

          const tbody = table.querySelector('tbody');

          items.forEach(item => {
            const areaName = item.Area?.Name || '---';
            const stations = item.Station || [];

            if (stations.length === 0) {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${areaName}</td>
                <td>---</td>
                <td>---</td>
                <td>---</td>
                <td>${announceTime}</td>
              `;
              tbody.appendChild(row);
            }

            stations.forEach(station => {
              const name = station.Name || '---';
              const condition = station.FirstHeight?.Condition || '---';
              const tideTime = formatDateTime(station.HighTideDateTime);

              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${areaName}</td>
                <td>${name}</td>
                <td>${condition}</td>
                <td>${tideTime}</td>
                <td>${announceTime}</td>
              `;
              tbody.appendChild(row);
            });
          });

          section.appendChild(table);
          sectionContainer.appendChild(section);
        });

        // 表示切り替え
        document.querySelector('h1').style.display = 'block';
        sectionContainer.style.display = 'block';

      } catch (e) {
        console.error("津波データ取得エラー:", e);
        document.getElementById('tsunamiSections').innerHTML =
          '<p style="text-align:center; color:red;">津波データの取得に失敗しました。</p>';
        document.getElementById('legend').innerHTML = '';
        // 表示切り替え
        document.querySelector('h1').style.display = 'block';
        document.getElementById('tsunamiSections').style.display = 'block';
      }
    }

    // メニュー切替イベント（地震選択時はquake.htmlに遷移）
    document.getElementById('infoSelector').addEventListener('change', (e) => {
      if (e.target.value === 'quake') {
        location.href = 'Quake.html'; // 適宜パス調整してください
      }
    });

    // 初期表示は津波情報ロード、さらに0.1秒ごとに自動更新（変更点）
    window.addEventListener('load', () => {
      loadTsunamiData();
      setInterval(() => {
        loadTsunamiData();
      }, 100); // 0.1秒ごとに呼ぶ
    });
  </script>

</body>
</html>